using _AsteroidsDOTS.Scripts.DataComponents;
using _AsteroidsDOTS.Scripts.DataComponents.Powerups;
using _AsteroidsDOTS.Scripts.DataComponents.Tags;
using Unity.Entities;

namespace _AsteroidsDOTS.Scripts.Systems.Powerups
{
    public class InvulnerabilitySystem : SystemBase
    {
        private EndInitializationEntityCommandBufferSystem m_endInitializationBuffer;
        private EntityQueryDesc m_queryDesc;

        protected override void OnCreate()
        {
            m_endInitializationBuffer = World.GetExistingSystem<EndInitializationEntityCommandBufferSystem>();
            m_queryDesc = new EntityQueryDesc()
            {
                All = new[]
                {
                    ComponentType.ReadWrite<EntityHealthData>(),
                    ComponentType.ReadWrite<InvulnerabilityShieldPowerUpData>(),
                    ComponentType.ReadOnly<PlayerTag>()
                }
            };

            RequireForUpdate(GetEntityQuery(m_queryDesc));
        }


        protected override void OnUpdate()
        {
            var l_ecb = m_endInitializationBuffer.CreateCommandBuffer();
            var l_deltaTime = Time.DeltaTime;
            var l_gameData = GetSingleton<GameData>();

            Entities.WithAll<PlayerTag>().ForEach(
                (Entity p_playerEntity, ref EntityHealthData p_playerHealthData,
                    ref InvulnerabilityShieldPowerUpData p_invulnerabilityShieldPowerUpData) =>
                {
                    if (!p_invulnerabilityShieldPowerUpData.IsInUse)
                    {
                        //Spawn shield
                        p_playerHealthData.CurrentInvincibilityTime = p_invulnerabilityShieldPowerUpData.Duration;
                        p_invulnerabilityShieldPowerUpData.IsInUse = true;
                        var l_shield = l_ecb.Instantiate(l_gameData.ShieldEntity);
                        p_invulnerabilityShieldPowerUpData.ShieldEntity = l_shield;
                        return;
                    }

                    p_invulnerabilityShieldPowerUpData.Duration -= l_deltaTime;

                    if (p_invulnerabilityShieldPowerUpData.ShouldExpire)
                    {
                        p_playerHealthData.CurrentInvincibilityTime = 0;
                        l_ecb.RemoveComponent<InvulnerabilityShieldPowerUpData>(p_playerEntity);
                        l_ecb.DestroyEntity(p_invulnerabilityShieldPowerUpData.ShieldEntity);
                    }
                }).Schedule();

            m_endInitializationBuffer.AddJobHandleForProducer(Dependency);
        }
    }
}